/**
 * test-replug.js â€” Run this IMMEDIATELY after physically replugging the MCDU.
 *
 * Tests two things:
 * 1. Does init (17x 0xf0 packets) clear the Winwing boot screen?
 * 2. Does display data with 40ms inter-packet delay show text?
 */

const HID = require('node-hid');

const VENDOR_ID = 0x4098;
const PRODUCT_ID = 0xbb36;

const INIT_PACKETS = [
    [0xf0,0x0,0x1,0x38,0x32,0xbb,0x0,0x0,0x1e,0x1,0x0,0x0,0xc4,0x24,0xa,0x0,0x0,0x0,0x0,0x0,0x0,0x32,0xbb,0x0,0x0,0x18,0x1,0x0,0x0,0xc4,0x24,0xa,0x0,0x0,0x8,0x0,0x0,0x0,0x34,0x0,0x18,0x0,0xe,0x0,0x18,0x0,0x32,0xbb,0x0,0x0,0x19,0x1,0x0,0x0,0xc4,0x24,0xa,0x0,0x0,0xe,0x0,0x0,0x0,0x0],
    [0xf0,0x0,0x2,0x38,0x0,0x0,0x0,0x1,0x0,0x5,0x0,0x0,0x0,0x2,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x32,0xbb,0x0,0x0,0x19,0x1,0x0,0x0,0xc4,0x24,0xa,0x0,0x0,0xe,0x0,0x0,0x0,0x1,0x0,0x6,0x0,0x0,0x0,0x3,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x32,0xbb,0x0,0x0,0x19,0x1,0x0,0x0,0x0,0x0,0x0,0x0],
    [0xf0,0x0,0x3,0x38,0x76,0x72,0x19,0x0,0x0,0xe,0x0,0x0,0x0,0x2,0x0,0x0,0x0,0x0,0xff,0x4,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x32,0xbb,0x0,0x0,0x19,0x1,0x0,0x0,0x76,0x72,0x19,0x0,0x0,0xe,0x0,0x0,0x0,0x2,0x0,0x0,0xa5,0xff,0xff,0x5,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x32,0xbb,0x0,0x0,0x0,0x0],
    [0xf0,0x0,0x4,0x38,0x0,0x0,0x19,0x1,0x0,0x0,0x76,0x72,0x19,0x0,0x0,0xe,0x0,0x0,0x0,0x2,0x0,0xff,0xff,0xff,0xff,0x6,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x32,0xbb,0x0,0x0,0x19,0x1,0x0,0x0,0x76,0x72,0x19,0x0,0x0,0xe,0x0,0x0,0x0,0x2,0x0,0xff,0xff,0x0,0xff,0x7,0x0,0x0,0x0,0x0,0x0,0x0,0x0],
    [0xf0,0x0,0x5,0x38,0x0,0x0,0x0,0x0,0x32,0xbb,0x0,0x0,0x19,0x1,0x0,0x0,0x76,0x72,0x19,0x0,0x0,0xe,0x0,0x0,0x0,0x2,0x0,0x3d,0xff,0x0,0xff,0x8,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x32,0xbb,0x0,0x0,0x19,0x1,0x0,0x0,0x76,0x72,0x19,0x0,0x0,0xe,0x0,0x0,0x0,0x2,0x0,0xff,0x63,0x0,0x0,0x0,0x0],
    [0xf0,0x0,0x6,0x38,0xff,0xff,0x9,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x32,0xbb,0x0,0x0,0x19,0x1,0x0,0x0,0x76,0x72,0x19,0x0,0x0,0xe,0x0,0x0,0x0,0x2,0x0,0x0,0x0,0xff,0xff,0xa,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x32,0xbb,0x0,0x0,0x19,0x1,0x0,0x0,0x76,0x72,0x19,0x0,0x0,0xe,0x0,0x0,0x0,0x0,0x0],
    [0xf0,0x0,0x7,0x38,0x0,0x0,0x2,0x0,0x0,0xff,0xff,0xff,0xb,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x32,0xbb,0x0,0x0,0x19,0x1,0x0,0x0,0x76,0x72,0x19,0x0,0x0,0xe,0x0,0x0,0x0,0x2,0x0,0x42,0x5c,0x61,0xff,0xc,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x32,0xbb,0x0,0x0,0x19,0x1,0x0,0x0,0x76,0x0,0x0,0x0,0x0],
    [0xf0,0x0,0x8,0x38,0x72,0x19,0x0,0x0,0xe,0x0,0x0,0x0,0x2,0x0,0x77,0x77,0x77,0xff,0xd,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x32,0xbb,0x0,0x0,0x19,0x1,0x0,0x0,0x76,0x72,0x19,0x0,0x0,0xe,0x0,0x0,0x0,0x2,0x0,0x5e,0x73,0x79,0xff,0xe,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x32,0xbb,0x0,0x0,0x0,0x0,0x0],
    [0xf0,0x0,0x9,0x38,0x0,0x19,0x1,0x0,0x0,0x76,0x72,0x19,0x0,0x0,0xe,0x0,0x0,0x0,0x3,0x0,0x20,0x20,0x20,0xff,0xf,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x32,0xbb,0x0,0x0,0x19,0x1,0x0,0x0,0x76,0x72,0x19,0x0,0x0,0xe,0x0,0x0,0x0,0x3,0x0,0x0,0xa5,0xff,0xff,0x10,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0],
    [0xf0,0x0,0xa,0x38,0x0,0x0,0x0,0x32,0xbb,0x0,0x0,0x19,0x1,0x0,0x0,0x76,0x72,0x19,0x0,0x0,0xe,0x0,0x0,0x0,0x3,0x0,0xff,0xff,0xff,0xff,0x11,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x32,0xbb,0x0,0x0,0x19,0x1,0x0,0x0,0x76,0x72,0x19,0x0,0x0,0xe,0x0,0x0,0x0,0x3,0x0,0xff,0xff,0x0,0x0,0x0,0x0,0x0],
    [0xf0,0x0,0xb,0x38,0xff,0x12,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x32,0xbb,0x0,0x0,0x19,0x1,0x0,0x0,0x76,0x72,0x19,0x0,0x0,0xe,0x0,0x0,0x0,0x3,0x0,0x3d,0xff,0x0,0xff,0x13,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x32,0xbb,0x0,0x0,0x19,0x1,0x0,0x0,0x76,0x72,0x19,0x0,0x0,0xe,0x0,0x0,0x0,0x0,0x0,0x0],
    [0xf0,0x0,0xc,0x38,0x0,0x3,0x0,0xff,0x63,0xff,0xff,0x14,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x32,0xbb,0x0,0x0,0x19,0x1,0x0,0x0,0x76,0x72,0x19,0x0,0x0,0xe,0x0,0x0,0x0,0x3,0x0,0x0,0x0,0xff,0xff,0x15,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x32,0xbb,0x0,0x0,0x19,0x1,0x0,0x0,0x76,0x72,0x0,0x0,0x0,0x0],
    [0xf0,0x0,0xd,0x38,0x19,0x0,0x0,0xe,0x0,0x0,0x0,0x3,0x0,0x0,0xff,0xff,0xff,0x16,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x32,0xbb,0x0,0x0,0x19,0x1,0x0,0x0,0x76,0x72,0x19,0x0,0x0,0xe,0x0,0x0,0x0,0x3,0x0,0x42,0x5c,0x61,0xff,0x17,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x32,0xbb,0x0,0x0,0x0,0x0,0x0,0x0],
    [0xf0,0x0,0xe,0x38,0x19,0x1,0x0,0x0,0x76,0x72,0x19,0x0,0x0,0xe,0x0,0x0,0x0,0x3,0x0,0x77,0x77,0x77,0xff,0x18,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x32,0xbb,0x0,0x0,0x19,0x1,0x0,0x0,0x76,0x72,0x19,0x0,0x0,0xe,0x0,0x0,0x0,0x3,0x0,0x5e,0x73,0x79,0xff,0x19,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0],
    [0xf0,0x0,0xf,0x38,0x0,0x0,0x32,0xbb,0x0,0x0,0x19,0x1,0x0,0x0,0x76,0x72,0x19,0x0,0x0,0xe,0x0,0x0,0x0,0x4,0x0,0x0,0x0,0x0,0x0,0x1a,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x32,0xbb,0x0,0x0,0x19,0x1,0x0,0x0,0x76,0x72,0x19,0x0,0x0,0xe,0x0,0x0,0x0,0x4,0x0,0x1,0x0,0x0,0x0,0x0,0x0,0x0,0x0],
    [0xf0,0x0,0x10,0x38,0x1b,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x32,0xbb,0x0,0x0,0x19,0x1,0x0,0x0,0x76,0x72,0x19,0x0,0x0,0xe,0x0,0x0,0x0,0x4,0x0,0x2,0x0,0x0,0x0,0x1c,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x32,0xbb,0x0,0x0,0x1a,0x1,0x0,0x0,0x76,0x72,0x19,0x0,0x0,0x1,0x0,0x0,0x0,0x0,0x0,0x0,0x0],
    [0xf0,0x0,0x11,0x12,0x2,0x32,0xbb,0x0,0x0,0x1c,0x1,0x0,0x0,0x76,0x72,0x19,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0],
];

const delay = ms => new Promise(r => setTimeout(r, ms));

async function run() {
    console.log('=== MCDU Replug Test ===');
    console.log('Connecting...');
    const dev = new HID.HID(VENDOR_ID, PRODUCT_ID);
    console.log('Connected.');

    // Step 1: Send all 17 init packets with small delays
    console.log('\n[STEP 1] Sending 17 init packets (10ms between each)...');
    console.log('         WATCH DISPLAY: does the Winwing logo disappear?');
    for (const pkt of INIT_PACKETS) {
        dev.write(Buffer.from(pkt));
        await delay(10);
    }
    console.log('         Init sent. Waiting 3s...');
    await delay(3000);

    // Step 2: Send display data with 40ms inter-packet delay (cduhub style)
    console.log('\n[STEP 2] Sending display data with 40ms delay between packets...');
    console.log('         WATCH DISPLAY: does text appear?');
    const LINES = [
        'REPLUG TEST - 40MS DELAY',
        'Q1: DID LOGO DISAPPEAR? ',
        'Q2: DO YOU SEE THIS TEXT',
        '                        ',
        '                        ',
        '                        ',
        '                        ',
        '                        ',
        '                        ',
        '                        ',
        '                        ',
        '                        ',
        '                        ',
        '                        ',
    ];
    const buf = [];
    for (let li = 0; li < 14; li++) {
        const text = LINES[li].padEnd(24, ' ');
        for (let ci = 0; ci < 24; ci++) {
            buf.push(0x42, 0x00, text.charCodeAt(ci)); // WHITE
        }
    }
    while (buf.length % 63 !== 0) buf.push(0);
    for (let i = 0; i < buf.length; i += 63) {
        dev.write(Buffer.from([0xf2, ...buf.slice(i, i + 63)]));
        await delay(40);
    }
    console.log('         Display data sent. Watching 8s...');
    await delay(8000);

    dev.close();
    console.log('\nDone. Report what you saw at each step.');
}

run().catch(e => { console.error('Error:', e.message); process.exit(1); });
